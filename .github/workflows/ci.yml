name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*.*.*']
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    name: ä»£ç éªŒè¯
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºä»£ç åˆ†æ

      - name: ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥
        run: |
          set -euo pipefail
          # æ£€æŸ¥å¹¶ç¦æ­¢ä½¿ç”¨é npm é”æ–‡ä»¶
          FOUND=$(find . -type f \( -name "pnpm-lock.yaml" -o -name "yarn.lock" \) | wc -l)
          if [ "$FOUND" -gt 0 ]; then
            echo "ğŸš¨ æ£€æµ‹åˆ°é npm é”æ–‡ä»¶ï¼ŒCI ç»ˆæ­¢ã€‚è¯·åˆ é™¤ä»¥ä¸‹æ–‡ä»¶å¹¶ç»Ÿä¸€ä½¿ç”¨ npm:"
            find . -type f \( -name "pnpm-lock.yaml" -o -name "yarn.lock" \)
            exit 1
          fi
          
          # ç¡®ä¿ package.json ä¸­ packageManager å­—æ®µæ ¼å¼æ­£ç¡®
          if ! grep -E '"packageManager": "npm@\d+\.\d+\.\d+"' package.json > /dev/null; then
            echo "ğŸš¨ package.json ä¸­çš„ packageManager å­—æ®µæ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º npm@X.Y.Z"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            **/package-lock.json
            **/package.json

      - name: å®‰è£…æ ¹é¡¹ç›®ä¾èµ–
        run: npm ci
        env:
          NODE_ENV: development

      - name: å®‰è£…å­é¡¹ç›®ä¾èµ–
        run: |
          # æ£€æŸ¥å¹¶å®‰è£… mobile ç›®å½•ä¾èµ–
          if [ -f "mobile/package.json" ]; then
            cd mobile
            npm ci
            cd ..
          fi

  type-check:
    name: TypeScript ç±»å‹æ£€æŸ¥
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: æ¢å¤ä¾èµ–
        run: npm ci

      - name: è¿è¡Œç±»å‹æ£€æŸ¥
        run: npm run type-check || tsc --noEmit

  lint:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: æ¢å¤ä¾èµ–
        run: npm ci

      - name: è¿è¡Œ ESLint æ£€æŸ¥
        run: npm run lint || echo "âš ï¸ lint å‘½ä»¤æœªé…ç½®ï¼Œè·³è¿‡æ£€æŸ¥"

      - name: æ£€æŸ¥ä»£ç æ ¼å¼åŒ–
        run: npm run format:check || echo "âš ï¸ format:check å‘½ä»¤æœªé…ç½®ï¼Œè·³è¿‡æ£€æŸ¥"

  unit-tests:
    name: å•å…ƒæµ‹è¯•
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: æ¢å¤ä¾èµ–
        run: npm ci

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: npm run test || echo "âš ï¸ æµ‹è¯•å‘½ä»¤æœªé…ç½®ï¼Œè·³è¿‡æµ‹è¯•"

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/

  e2e-tests:
    name: E2E æµ‹è¯•
    needs: [type-check, lint, unit-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: æ¢å¤ä¾èµ–
        run: npm ci

      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: npx playwright install --with-deps

      - name: è¿è¡Œ E2E æµ‹è¯•
        run: npm run test:e2e
        env:
          CI: true
          NEXT_PUBLIC_TEST_ENV: ci

      - name: ä¸Šä¼  Playwright æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  build:
    name: æ„å»ºéªŒè¯
    needs: [type-check, lint, unit-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: æ¢å¤ä¾èµ–
        run: npm ci

      - name: æ„å»ºé¡¹ç›®
        run: npm run build
        env:
          NODE_ENV: production
          # æ·»åŠ å…¶ä»–ç”Ÿäº§ç¯å¢ƒæ‰€éœ€çš„ç¯å¢ƒå˜é‡
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: éªŒè¯æ„å»ºè¾“å‡º
        run: |
          # æ£€æŸ¥å…³é”®è¾“å‡ºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -d ".next" ]; then
            echo "ğŸš¨ æ„å»ºå¤±è´¥ï¼š.next ç›®å½•æœªç”Ÿæˆ"
            exit 1
          fi
          if [ ! -f ".next/server/app/page.js" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°é¡µé¢æ„å»ºè¾“å‡ºï¼Œå¯èƒ½å­˜åœ¨æ„å»ºé—®é¢˜"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next/
          retention-days: 3

  # å¯é€‰ï¼šéƒ¨ç½²æ­¥éª¤ï¼ˆä»…åœ¨ main åˆ†æ”¯æˆ–æ ‡ç­¾æ¨é€æ—¶è§¦å‘ï¼‰
  deploy:
    name: éƒ¨ç½²
    needs: [build, e2e-tests]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²è¯´æ˜
        run: echo "éƒ¨ç½²æ­¥éª¤å°†åœ¨æ­¤é…ç½®ï¼Œå½“å‰ä¸ºå ä½ç¬¦"
        # å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ å…·ä½“çš„éƒ¨ç½²é€»è¾‘ï¼Œå¦‚ Vercelã€Netlifyã€AWS ç­‰éƒ¨ç½²å‘½ä»¤
